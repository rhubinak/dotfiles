#!/usr/bin/sh

set -euo pipefail
shopt -s failglob

USER="system"
PASSWORD=""
DB="xe"

# SQL Plus
#sqlplus sys/Pa$$w0rd@//localhost:1521/XE as sysdba

#ALTER SESSION SET CONTAINER=XEPDB1;

# Create tablespaces. In case of error try running 'unset NLS_LANG'
sqlplus -S "${USER}"/"${PASSWORD}"@"${DB}" <<EOF
CREATE TABLESPACE TS3TABLES DATAFILE '/opt/oracle/oradata/XE/TS3TABLES.dbf' SIZE 6G EXTENT MANAGEMENT LOCAL AUTOALLOCATE;
CREATE TABLESPACE TS3INDEX DATAFILE '/opt/oracle/oradata/XE/TS3INDEX.dbf' SIZE 3G EXTENT MANAGEMENT LOCAL AUTOALLOCATE;
EOF

# Create users
sqlplus -S "${USER}"/"${PASSWORD}"@"${DB}" <<EOF
CREATE USER VM_51HF_FULL IDENTIFIED BY "${PASSWORD}" DEFAULT TABLESPACE TS3TABLES TEMPORARY TABLESPACE TEMP;
ALTER USER VM_51HF_FULL QUOTA UNLIMITED ON TS3INDEX;
GRANT CONNECT, DBA TO VM_51HF_FULL;
CREATE USER VM_51HF_FULL_ORIG IDENTIFIED BY "${PASSWORD}" DEFAULT TABLESPACE TS3TABLES TEMPORARY TABLESPACE TEMP;
ALTER USER VM_51HF_FULL_ORIG QUOTA UNLIMITED ON TS3INDEX;
GRANT CONNECT, DBA TO VM_51HF_FULL_ORIG;
EOF

# Import DB dumps
imp "${USER}"/"${PASSWORD}"@"${DB}" FILE='VM_MAIN_DEV_FULL.dmp' FROMUSER=VM_MAIN_DEV_FULL TOUSER=VM_51HF_FULL GRANTS=Y
imp "${USER}"/"${PASSWORD}"@"${DB}" FILE='VM_MAIN_DEV_FULL.dmp' FROMUSER=VM_MAIN_DEV_FULL TOUSER=VM_51HF_FULL_ORIG GRANTS=Y
